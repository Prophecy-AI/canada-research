# PlanTask Tool Documentation

## Overview

The `PlanTask` tool is a separate planning tool that uses a reasoning model (default: `claude-opus-4-20250514`) to create detailed execution plans before the agent begins executing complex tasks.

## Why Use PlanTask?

**Benefits of separate planning:**
- **Better reasoning**: Uses a dedicated reasoning model optimized for planning
- **Reduced errors**: Creates structured plan before execution
- **Clear strategy**: Identifies dependencies, risks, and validation steps upfront
- **Improved observability**: Plan is visible in conversation history
- **Cost optimization**: Planning model runs once, execution model follows the plan

## Architecture

```
User Request
     ↓
PlanTask Tool (claude-opus-4-20250514)
     ↓
Detailed Execution Plan
     ↓
Execution Tools (claude-sonnet-4-5-20250929)
     ↓
Results
```

## Usage

The agent will automatically call `PlanTask` when appropriate for complex multi-step tasks. You can also explicitly request it:

```
User: "Plan how to analyze the sales data and create a report"

Agent: [Calls PlanTask tool]

PlanTask Output:
# Execution Plan (Generated by claude-opus-4-20250514)

## 1. Goal Analysis
- Analyze sales data from CSV/database
- Create comprehensive report
- Success criteria: Report includes trends, insights, visualizations

## 2. Step-by-Step Execution Plan
1. **Data Loading** (Read tool)
   - Locate sales data file
   - Read and validate format

2. **Data Analysis** (Bash + Python)
   - Calculate key metrics (revenue, growth, etc.)
   - Identify trends and patterns
   - Create visualizations

3. **Report Generation** (Write tool)
   - Compile findings into structured report
   - Include visualizations
   - Add recommendations

## 3. Data Requirements
- Sales data CSV with columns: date, product, revenue, quantity
- Historical data for trend analysis

## 4. Risk Assessment
- Missing or corrupted data → Add validation step
- Large datasets → Consider sampling or chunking
- Date format inconsistencies → Normalize dates

## 5. Validation Strategy
- Verify data loaded correctly (check row count, columns)
- Validate calculations (spot-check against raw data)
- Review report completeness

---

Agent: [Proceeds to execute plan step by step]
```

## Configuration

### Setting Planning Model

The planning model can be configured via environment variable:

```bash
# Use Claude Opus for planning (default)
export PLANNING_MODEL="claude-opus-4-20250514"

# Or use another reasoning model
export PLANNING_MODEL="claude-sonnet-4-5-20250929"
```

### When Planning is Triggered

The agent decides when to use PlanTask based on:
- **Task complexity**: Multi-step tasks with dependencies
- **Risk level**: Tasks involving data deletion, production systems
- **Ambiguity**: Unclear requirements that need decomposition
- **User request**: Explicit "plan" or "strategy" requests

## Tool Schema

```python
{
    "name": "PlanTask",
    "description": "Create detailed execution plan using reasoning model",
    "input_schema": {
        "type": "object",
        "properties": {
            "task_description": {
                "type": "string",
                "description": "Clear description of what needs to be accomplished"
            },
            "context": {
                "type": "string",
                "description": "Additional context (optional)"
            }
        },
        "required": ["task_description"]
    }
}
```

## Implementation Details

### Code Location

- **Tool Implementation**: [agent_v5/tools/plan.py](../agent_v5/tools/plan.py)
- **Tests**: [agent_v5/tests/test_plan.py](../agent_v5/tests/test_plan.py)
- **Registration**: [agent_v5/agent.py](../agent_v5/agent.py#L45)

### Key Features

1. **Conversation Context**: Accesses conversation history for context
2. **Available Tools**: Plans around available tools (Bash, Read, Write, etc.)
3. **Structured Output**: Returns markdown-formatted plan with sections:
   - Goal Analysis
   - Step-by-Step Execution Plan
   - Data Requirements
   - Risk Assessment
   - Validation Strategy

### Integration

The tool is automatically registered in `ResearchAgent`:

```python
def _register_core_tools(self):
    # Planning tool (uses conversation history for context)
    self.tools.register(PlanTaskTool(
        self.workspace_dir,
        lambda: self.conversation_history
    ))

    # ... other tools
```

## Example Scenarios

### Scenario 1: Data Pipeline

**User**: "Create a pipeline to analyze healthcare claims data"

**PlanTask Output**:
- Identifies need for BigQuery query tool
- Plans data validation steps
- Includes HIPAA compliance checks
- Suggests error handling strategy

### Scenario 2: Complex Analysis

**User**: "Find correlations between prescribers and patient outcomes"

**PlanTask Output**:
- Breaks into: data extraction, joining datasets, statistical analysis
- Identifies required statistical methods
- Plans intermediate validation steps
- Suggests visualization approach

### Scenario 3: Risky Operations

**User**: "Clean up old log files from production"

**PlanTask Output**:
- Emphasizes backup strategy
- Plans verification before deletion
- Suggests dry-run approach
- Identifies rollback plan

## Testing

Run the comprehensive test suite:

```bash
python -m pytest agent_v5/tests/test_plan.py -v
```

**Test Coverage**:
- Basic task planning
- Planning with context
- Conversation history integration
- Complex multi-step tasks
- Tool schema validation
- Model configuration
- Error handling
- Risk identification

All 9 tests pass with real API calls to Anthropic.

## Cost Considerations

- **Planning call**: ~2-8K tokens (one-time per complex task)
- **Execution calls**: Standard sonnet pricing (multiple calls)
- **Trade-off**: Small upfront planning cost → fewer execution errors → lower total cost

## Best Practices

1. **Use for complex tasks**: Don't plan trivial operations
2. **Provide context**: Include constraints, requirements, known limitations
3. **Review plans**: Plan is visible in conversation, verify before execution
4. **Iterative refinement**: If plan is unclear, ask for refinement
5. **Trust the plan**: The reasoning model is optimized for planning

## Future Enhancements

Potential improvements:
- **Plan persistence**: Save plans to workspace for reference
- **Plan revision**: Allow plan updates based on execution results
- **Multi-agent planning**: Coordinate plans across sub-agents
- **Plan templates**: Domain-specific planning templates
- **Cost tracking**: Track planning vs execution costs separately
