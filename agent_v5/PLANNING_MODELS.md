# Planning Models in Agent V5

Agent V5 supports using different LLMs for the planning phase vs the execution phase. This allows you to leverage specialized reasoning models (like OpenAI's o3 or o1) for complex planning while using Claude for execution.

## How It Works

The `PlanTaskTool` is automatically registered with the agent and can be called at the start of complex tasks to create a detailed execution plan. The planning model can be different from the main execution model.

**Architecture:**
```
User Request
    ↓
Main Agent (Claude Sonnet 4.5)
    ↓
Calls PlanTaskTool
    ↓
Planning Model (o3-mini, o1, Claude Opus, etc.)
    ↓
Returns detailed plan
    ↓
Main Agent executes plan using tools
    ↓
Final result
```

## Supported Planning Models

### Anthropic Models (Default)
- `claude-opus-4-20250514` (default) - Best for complex reasoning
- `claude-sonnet-4-5-20250929` - Fast and capable

### OpenAI Models
- `o3-mini` - **Recommended for planning** - Fast reasoning model
- `o1` - Advanced reasoning (slower, more expensive)
- `o1-mini` - Lightweight reasoning
- `gpt-4o` - General purpose (if you just want OpenAI)

## Configuration

Set the `PLANNING_MODEL` environment variable to choose your planning model:

```bash
# Use OpenAI o3-mini for planning (recommended)
export PLANNING_MODEL=o3-mini
export OPENAI_API_KEY=sk-...

# Use OpenAI o1 for advanced reasoning
export PLANNING_MODEL=o1
export OPENAI_API_KEY=sk-...

# Use Claude Opus for planning (default)
export PLANNING_MODEL=claude-opus-4-20250514
export ANTHROPIC_API_KEY=sk-ant-...

# Use Claude Sonnet for planning
export PLANNING_MODEL=claude-sonnet-4-5-20250929
export ANTHROPIC_API_KEY=sk-ant-...
```

## Required API Keys

**For Anthropic models:**
```bash
export ANTHROPIC_API_KEY=sk-ant-...
```

**For OpenAI models:**
```bash
export OPENAI_API_KEY=sk-...
```

**Note:** The main agent always requires `ANTHROPIC_API_KEY` (it uses Claude for execution). The `OPENAI_API_KEY` is only needed if you set `PLANNING_MODEL` to an OpenAI model.

## Usage Example

### Automatic Planning (Recommended)

The agent can automatically call the PlanTask tool when it detects a complex task:

```python
from agent_v5.agent import ResearchAgent

# Agent will use o3-mini for planning, Claude for execution
agent = ResearchAgent(
    session_id="test",
    workspace_dir="./workspace",
    system_prompt="You are a helpful research assistant..."
)

# For complex tasks, the agent will automatically use PlanTask
response = await agent.run(
    "Analyze the NYC taxi dataset, find peak hours, "
    "create visualizations, and write a summary report"
)
```

### Manual Planning

You can also explicitly request planning:

```python
response = await agent.run(
    "Use the PlanTask tool to create a detailed plan for:\n"
    "1. Downloading and preprocessing the dataset\n"
    "2. Running statistical analysis\n"
    "3. Creating visualizations\n"
    "4. Writing a final report"
)
```

## What the Planning Model Receives

The planning model receives:
- **Task description**: What needs to be accomplished
- **Context**: Any additional information provided
- **Conversation history**: Recent context from the conversation
- **Available tools**: List of all tools the agent can use

The planning model returns a structured plan with:
1. **Goal Analysis**: Objectives, success criteria, challenges
2. **Step-by-Step Execution Plan**: Numbered steps with tools to use
3. **Data Requirements**: What data/files are needed
4. **Risk Assessment**: Potential failure points and mitigations
5. **Validation Strategy**: How to verify success

## Example Plan Output

```markdown
# Execution Plan (Generated by o3-mini)

## 1. Goal Analysis

**Core Objective:**
Analyze NYC taxi dataset to identify peak hours and create a summary report with visualizations.

**Success Criteria:**
- Peak hours identified with statistical confidence
- Clear visualizations showing patterns
- Professional summary report

**Key Challenges:**
- Dataset size and memory constraints
- Handling missing/invalid data
- Choosing appropriate visualization types

## 2. Step-by-Step Execution Plan

**Step 1: Data Loading & Validation**
- Tool: Bash + Read
- Check if dataset exists in workspace
- Load first 1000 rows to validate schema
- Expected output: Schema confirmation

**Step 2: Data Preprocessing**
- Tool: Write (Python script)
- Clean missing values
- Convert datetime columns
- Expected output: cleaned_data.csv

**Step 3: Peak Hour Analysis**
- Tool: Bash (run analysis script)
- Group by hour, calculate ride counts
- Identify statistical peaks
- Expected output: peak_hours.json

[... and so on ...]

## 3. Data Requirements
- Input: nyc_taxi.csv (must be in workspace)
- Libraries: pandas, matplotlib, numpy
- Output: report.md, visualizations/*.png

## 4. Risk Assessment
- **Risk**: Dataset too large for memory
  - **Mitigation**: Use chunked processing with pandas
- **Risk**: Missing datetime values
  - **Mitigation**: Drop or impute based on context

## 5. Validation Strategy
- Verify cleaned dataset has no nulls in key columns
- Check visualizations render correctly
- Ensure report contains all required sections
```

## Performance Considerations

### Speed
- **o3-mini**: ~5-10 seconds for planning
- **o1-mini**: ~10-20 seconds for planning
- **o1**: ~20-60 seconds for planning (uses extended thinking time)
- **Claude Opus**: ~3-8 seconds for planning

### Cost
Planning is called once at the start of a task:
- **o3-mini**: ~$0.01-0.05 per plan (recommended)
- **o1-mini**: ~$0.05-0.15 per plan
- **o1**: ~$0.20-0.60 per plan
- **Claude Opus**: ~$0.02-0.10 per plan

**Recommendation:** Use `o3-mini` for best speed/cost/quality balance.

## When to Use Planning

Planning is most valuable for:
- ✅ Multi-step data analysis workflows
- ✅ Complex file operations with dependencies
- ✅ Tasks requiring data transformations
- ✅ Research tasks with unclear approaches
- ✅ Tasks where mistakes are costly

Planning is less useful for:
- ❌ Simple single-step tasks
- ❌ Tasks with well-defined procedures
- ❌ Quick file reads or searches

## Troubleshooting

### Error: "No module named 'openai'"

**Solution:** Install the OpenAI package:
```bash
pip install openai
```

### Error: "OPENAI_API_KEY not set"

**Solution:** Set your OpenAI API key:
```bash
export OPENAI_API_KEY=sk-...
```

### Planning takes too long

**Solution:** Switch to a faster model:
```bash
# From o1 (slow) to o3-mini (fast)
export PLANNING_MODEL=o3-mini
```

### Planning model not being used

**Solution:** Verify the environment variable is set:
```bash
echo $PLANNING_MODEL
```

If empty, the agent will use the default (Claude Opus).

## Advanced: Custom Planning Prompts

The planning prompt is defined in `agent_v5/tools/plan.py`. You can modify it to customize:
- The structure of plans
- What information is included
- The level of detail
- Domain-specific requirements

Example customization:

```python
# In plan.py, modify the planning_prompt variable
planning_prompt = f"""You are a {DOMAIN}-specific planning expert...

**Domain-Specific Considerations:**
- {DOMAIN_SPECIFIC_CONSTRAINT_1}
- {DOMAIN_SPECIFIC_CONSTRAINT_2}

[... rest of prompt ...]
"""
```

## Integration with mle-bench

When using agent_v5 with mle-bench (Kaggle competitions):

```bash
# Use o3-mini for planning Kaggle competition strategies
export PLANNING_MODEL=o3-mini
export OPENAI_API_KEY=sk-...
export ANTHROPIC_API_KEY=sk-ant-...

cd mle-bench
./RUN_AGENT_V5_KAGGLE.sh
```

The agent will use o3-mini to plan:
- Data exploration strategies
- Feature engineering approaches
- Model selection and hyperparameter tuning
- Validation strategies

Then Claude executes the plan using the available tools.

## Summary

**Best Practice Configuration:**

```bash
# For production use (best balance)
export PLANNING_MODEL=o3-mini
export OPENAI_API_KEY=sk-...
export ANTHROPIC_API_KEY=sk-ant-...

# For development (fastest)
export PLANNING_MODEL=claude-sonnet-4-5-20250929
export ANTHROPIC_API_KEY=sk-ant-...

# For maximum reasoning (expensive)
export PLANNING_MODEL=o1
export OPENAI_API_KEY=sk-...
export ANTHROPIC_API_KEY=sk-ant-...
```

**Key Takeaways:**
- ✅ Planning and execution can use different models
- ✅ `o3-mini` recommended for most use cases
- ✅ Planning is called once at the start of complex tasks
- ✅ Main agent (Claude) executes the plan
- ✅ Both API keys needed if using OpenAI for planning

---

**Last updated:** 2025-10-17
